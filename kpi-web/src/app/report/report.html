<div class="flex h-screen bg-gray-100 font-sans overflow-hidden">
  <!-- Mobile Sidebar Overlay -->
  <div *ngIf="isSidebarOpen" class="fixed inset-0 bg-black/50 z-10 lg:hidden no-print" (click)="toggleSidebar()"></div>

  <!-- Sidebar -->
  <aside class="bg-gradient-to-b from-green-800 to-green-600 text-white flex flex-col shadow-xl z-20 transition-all duration-700 ease-in-out overflow-hidden whitespace-nowrap fixed lg:relative h-full lg:h-auto no-print" [ngClass]="isSidebarOpen ? 'w-64 opacity-100 translate-x-0' : 'w-0 opacity-0 -translate-x-full lg:translate-x-0'">
    <div class="h-16 flex items-center px-6 border-b border-green-500/30 bg-green-900/20">
      <i class="fas fa-heartbeat text-2xl mr-3"></i>
      <span class="text-lg font-bold tracking-wide">Korat Health KPI</span>
      <button (click)="toggleSidebar()" class="ml-auto text-white hover:text-green-200 focus:outline-none lg:hidden">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
    </div>

    <nav class="flex-1 px-4 py-6 space-y-2 overflow-y-auto">
      <a routerLink="/charts" class="flex items-center px-4 py-3 text-green-100 hover:bg-white/10 hover:text-white rounded-xl transition-colors cursor-pointer">
        <i class="fas fa-chart-bar text-xl mr-3 min-w-[24px]"></i>
        <span class="truncate">รายงานสถิติ</span>
      </a>
      <a routerLink="/reports" class="flex items-center px-4 py-3 bg-white/10 text-white rounded-xl transition-colors cursor-pointer font-medium">
        <i class="fas fa-file-alt text-xl mr-3 min-w-[24px]"></i>
        <span class="truncate">รายงานสรุปผล</span>
      </a>
      <a routerLink="/dashboard" class="flex items-center px-4 py-3 text-green-100 hover:bg-white/10 hover:text-white rounded-xl transition-colors cursor-pointer">
        <i class="fas fa-th-large text-xl mr-3 min-w-[24px]"></i>
        <span class="truncate flex justify-between items-center w-full">
          ภาพรวมตัวชี้วัด
          <span *ngIf="(isAdmin || isSuperAdmin) && pendingKpiCount > 0" class="flex h-5 w-5 items-center justify-center rounded-full bg-red-500 text-[10px] font-bold text-white ml-2 animate-pulse shadow-lg">
            {{ pendingKpiCount }}
          </span>
        </span>
      </a>
      <a *ngIf="isAdmin || isSuperAdmin" routerLink="/users" class="flex items-center px-4 py-3 text-green-100 hover:bg-white/10 hover:text-white rounded-xl transition-colors cursor-pointer">
        <i class="fas fa-users-cog text-xl mr-3 min-w-[24px]"></i>
        <span class="truncate">จัดการผู้ใช้งาน</span>
      </a>
      <a *ngIf="isAdmin || isSuperAdmin" routerLink="/kpi-manage" class="flex items-center px-4 py-3 text-green-100 hover:bg-white/10 hover:text-white rounded-xl transition-colors cursor-pointer">
        <i class="fas fa-tasks text-xl mr-3 min-w-[24px]"></i>
        <span class="truncate">จัดการตัวชี้วัด</span>
      </a>
      <a *ngIf="isAdmin || isSuperAdmin" routerLink="/audit-logs" class="flex items-center px-4 py-3 text-green-100 hover:bg-white/10 hover:text-white rounded-xl transition-colors cursor-pointer">
        <i class="fas fa-history text-xl mr-3 min-w-[24px]"></i>
        <span class="truncate">ประวัติการใช้งาน</span>
      </a>
      <a *ngIf="isAdmin || isSuperAdmin" routerLink="/kpi-setup" class="flex items-center px-4 py-3 text-green-100 hover:bg-white/10 hover:text-white rounded-xl transition-colors cursor-pointer">
        <i class="fas fa-plus-circle text-xl mr-3 min-w-[24px]"></i>
        <span class="truncate">+KPI ปีงบประมาณใหม่</span>
      </a>
      <a *ngIf="isAdmin || isSuperAdmin" routerLink="/settings" class="flex items-center px-4 py-3 text-green-100 hover:bg-white/10 hover:text-white rounded-xl transition-colors cursor-pointer">
        <i class="fas fa-sliders-h text-xl mr-3 min-w-[24px]"></i>
        <span class="truncate">ตั้งค่าระบบ</span>
      </a>
    </nav>

    <div class="p-4 border-t border-green-500/30">
      <button (click)="openChangePasswordModal()" class="flex items-center w-full px-4 py-3 text-green-100 hover:bg-white/10 hover:text-white rounded-xl transition-colors cursor-pointer mb-1">
        <i class="fas fa-key text-xl mr-3 min-w-[24px]"></i>
        <span class="truncate">เปลี่ยนรหัสผ่าน</span>
      </button>
      <button (click)="logout()" class="flex items-center w-full px-4 py-3 text-green-100 hover:bg-red-500 hover:text-white rounded-xl transition-colors cursor-pointer">
        <i class="fas fa-sign-out-alt text-xl mr-3 min-w-[24px]"></i>
        <span class="truncate">ออกจากระบบ</span>
      </button>
      <div class="mt-4 text-center text-xs text-green-200/60 font-mono">{{ systemVersion }}</div>
    </div>
  </aside>

  <!-- Main Content -->
  <div class="flex-1 flex flex-col overflow-hidden">
    <header class="h-16 bg-gradient-to-r from-green-800 to-green-600 shadow-md flex items-center justify-between px-6 z-10 no-print">
      <div class="flex items-center">
        <button (click)="toggleSidebar()" class="text-white hover:text-green-200 focus:outline-none mr-4 lg:hidden">
          <i class="fas fa-bars text-xl"></i>
        </button>
        <button (click)="toggleSidebar()" class="text-white hover:text-green-200 focus:outline-none mr-4 hidden lg:block" [ngClass]="isSidebarOpen ? 'hidden' : 'block'">
          <i class="fas fa-bars text-xl"></i>
        </button>
        <h2 class="text-lg sm:text-xl font-semibold text-white">รายงานสรุปผล KPI</h2>
        <span *ngIf="(isAdmin || isSuperAdmin) && pendingKpiCount > 0" class="flex h-6 min-w-[24px] px-1.5 items-center justify-center rounded-full bg-red-500 text-[11px] font-bold text-white ml-2 animate-pulse shadow-lg">
          {{ pendingKpiCount }}
        </span>
      </div>
      <div class="flex items-center">
        <div class="text-right mr-3 hidden sm:block">
          <p class="text-sm font-bold text-white">({{ currentUser?.role }}) {{ currentUser?.firstname }} {{ currentUser?.lastname }}</p>
          <p class="text-xs text-green-100">{{ currentUser?.dept_name ? currentUser?.dept_name : '' }} {{ currentUser?.service_unit }}</p>
        </div>
        <div class="h-10 w-10 rounded-full bg-white/20 border-2 border-white/30 flex items-center justify-center text-white font-bold backdrop-blur-sm">
          {{ currentUser?.username?.charAt(0).toUpperCase() }}
        </div>
      </div>
    </header>

    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 p-6 relative">
      <!-- Loading -->
      <div *ngIf="isLoading" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-white/80 backdrop-blur-sm">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-green-600 mb-4"></div>
        <p class="text-green-800 font-bold text-lg animate-pulse">กำลังโหลดข้อมูล...</p>
      </div>

      <!-- Print Header -->
      <div class="print-header hidden">
        <h1 class="text-xl font-bold text-center">รายงานสรุปผล KPI สำนักงานสาธารณสุขจังหวัดนครราชสีมา</h1>
        <p class="text-center text-sm text-gray-600 mt-1">ปีงบประมาณ {{ selectedYear || 'ทั้งหมด' }}</p>
      </div>

      <!-- Tabs -->
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 mb-6 no-print">
        <div class="flex border-b border-gray-200 overflow-x-auto">
          <button (click)="switchTab('by-indicator')" [class]="activeTab === 'by-indicator' ? 'border-green-500 text-green-600 bg-green-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'" class="flex-1 min-w-[140px] py-3 px-4 text-center border-b-2 font-medium text-sm focus:outline-none transition-colors">
            <i class="fas fa-list-ol mr-1.5"></i> รายข้อตัวชี้วัด
          </button>
          <button (click)="switchTab('by-hospital')" [class]="activeTab === 'by-hospital' ? 'border-green-500 text-green-600 bg-green-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'" class="flex-1 min-w-[140px] py-3 px-4 text-center border-b-2 font-medium text-sm focus:outline-none transition-colors">
            <i class="fas fa-hospital mr-1.5"></i> รายหน่วยบริการ
          </button>
          <button (click)="switchTab('by-district')" [class]="activeTab === 'by-district' ? 'border-green-500 text-green-600 bg-green-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'" class="flex-1 min-w-[140px] py-3 px-4 text-center border-b-2 font-medium text-sm focus:outline-none transition-colors">
            <i class="fas fa-map-marker-alt mr-1.5"></i> รายอำเภอ
          </button>
          <button (click)="switchTab('by-year')" [class]="activeTab === 'by-year' ? 'border-green-500 text-green-600 bg-green-50' : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'" class="flex-1 min-w-[140px] py-3 px-4 text-center border-b-2 font-medium text-sm focus:outline-none transition-colors">
            <i class="fas fa-calendar-alt mr-1.5"></i> รายปีงบประมาณ
          </button>
        </div>
      </div>

      <!-- Filters -->
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 sm:p-6 mb-6 no-print">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-3 sm:gap-4 items-end">
          <div>
            <label class="block text-xs font-bold text-gray-500 mb-1.5 uppercase">ปีงบประมาณ</label>
            <select [(ngModel)]="selectedYear" (change)="onFilterChange()" class="w-full px-3 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none text-sm hover:border-green-400 transition-colors">
              <option value="">ทั้งหมด</option>
              <option *ngFor="let y of filterYears" [value]="y">{{ y }}</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-bold text-gray-500 mb-1.5 uppercase">หน่วยงาน</label>
            <select [(ngModel)]="selectedDeptId" (change)="onFilterChange()" class="w-full px-3 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none text-sm hover:border-green-400 transition-colors">
              <option value="">ทั้งหมด</option>
              <option *ngFor="let d of departments" [value]="d.id">{{ d.dept_name }}</option>
            </select>
          </div>
          <div *ngIf="activeTab !== 'by-year'">
            <label class="block text-xs font-bold text-gray-500 mb-1.5 uppercase">อำเภอ</label>
            <select [(ngModel)]="selectedDistId" (change)="onFilterChange()" class="w-full px-3 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none text-sm hover:border-green-400 transition-colors">
              <option value="">ทั้งหมด</option>
              <option *ngFor="let dist of districts" [value]="dist.distid">{{ dist.distname }}</option>
            </select>
          </div>
          <div class="flex gap-2 items-end">
            <button (click)="clearFilters()" class="px-4 py-2.5 border border-gray-300 text-gray-600 hover:bg-gray-100 rounded-xl text-sm font-bold transition-colors">
              <i class="fas fa-times mr-1"></i> ล้าง
            </button>
          </div>
          <div class="flex gap-2 items-end">
            <button (click)="exportExcel()" class="px-4 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-xl text-sm font-bold shadow-md transition-colors">
              <i class="fas fa-file-excel mr-1"></i> Excel
            </button>
            <button (click)="printReport()" class="px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-xl text-sm font-bold shadow-md transition-colors">
              <i class="fas fa-print mr-1"></i> Print
            </button>
          </div>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="bg-gradient-to-br from-green-500 to-green-700 rounded-2xl p-5 text-white shadow-lg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs font-bold text-green-100 uppercase">จำนวนตัวชี้วัด</p>
              <p class="text-3xl font-extrabold mt-1">{{ summaryStats.totalIndicators }}</p>
            </div>
            <div class="h-12 w-12 rounded-full bg-white/20 flex items-center justify-center">
              <i class="fas fa-list-ol text-xl"></i>
            </div>
          </div>
        </div>
        <div class="bg-gradient-to-br from-blue-500 to-blue-700 rounded-2xl p-5 text-white shadow-lg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs font-bold text-blue-100 uppercase">จำนวนหน่วยบริการ</p>
              <p class="text-3xl font-extrabold mt-1">{{ summaryStats.totalHospitals }}</p>
            </div>
            <div class="h-12 w-12 rounded-full bg-white/20 flex items-center justify-center">
              <i class="fas fa-hospital text-xl"></i>
            </div>
          </div>
        </div>
        <div class="bg-gradient-to-br from-yellow-500 to-orange-600 rounded-2xl p-5 text-white shadow-lg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs font-bold text-yellow-100 uppercase">%ผลสำเร็จเฉลี่ย</p>
              <p class="text-3xl font-extrabold mt-1">{{ summaryStats.avgAchievement }}%</p>
            </div>
            <div class="h-12 w-12 rounded-full bg-white/20 flex items-center justify-center">
              <i class="fas fa-chart-line text-xl"></i>
            </div>
          </div>
        </div>
        <div class="bg-gradient-to-br from-purple-500 to-purple-700 rounded-2xl p-5 text-white shadow-lg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs font-bold text-purple-100 uppercase">ผลงานรวม</p>
              <p class="text-3xl font-extrabold mt-1">{{ summaryStats.totalActual | number:'1.2-2' }}</p>
            </div>
            <div class="h-12 w-12 rounded-full bg-white/20 flex items-center justify-center">
              <i class="fas fa-trophy text-xl"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Data Table -->
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-6">
        <!-- Tab: by-indicator -->
        <div *ngIf="activeTab === 'by-indicator'" class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-green-50 text-green-800">
              <tr>
                <th class="px-4 py-3 text-left font-bold">#</th>
                <th class="px-4 py-3 text-left font-bold">หมวดหมู่หลัก</th>
                <th class="px-4 py-3 text-left font-bold">ชื่อตัวชี้วัด</th>
                <th class="px-4 py-3 text-left font-bold">หน่วยงาน</th>
                <th class="px-4 py-3 text-right font-bold">เป้าหมาย</th>
                <th class="px-4 py-3 text-right font-bold">ต.ค.</th>
                <th class="px-4 py-3 text-right font-bold">พ.ย.</th>
                <th class="px-4 py-3 text-right font-bold">ธ.ค.</th>
                <th class="px-4 py-3 text-right font-bold">ม.ค.</th>
                <th class="px-4 py-3 text-right font-bold">ก.พ.</th>
                <th class="px-4 py-3 text-right font-bold">มี.ค.</th>
                <th class="px-4 py-3 text-right font-bold">เม.ย.</th>
                <th class="px-4 py-3 text-right font-bold">พ.ค.</th>
                <th class="px-4 py-3 text-right font-bold">มิ.ย.</th>
                <th class="px-4 py-3 text-right font-bold">ก.ค.</th>
                <th class="px-4 py-3 text-right font-bold">ส.ค.</th>
                <th class="px-4 py-3 text-right font-bold">ก.ย.</th>
                <th class="px-4 py-3 text-right font-bold">ผลงานรวม</th>
                <th class="px-4 py-3 text-right font-bold">%สำเร็จ</th>
                <th class="px-4 py-3 text-center font-bold">รพ.</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of reportData; let i = index" class="border-b border-gray-50 hover:bg-green-50/30 transition-colors">
                <td class="px-4 py-2.5 text-gray-500">{{ i + 1 }}</td>
                <td class="px-4 py-2.5 text-gray-700 max-w-[150px] truncate">{{ item.main_indicator_name }}</td>
                <td class="px-4 py-2.5 text-gray-800 font-medium max-w-[200px] truncate">{{ item.kpi_indicators_name }}</td>
                <td class="px-4 py-2.5 text-gray-600">{{ item.dept_name }}</td>
                <td class="px-4 py-2.5 text-right text-gray-700">{{ (item.target_value | number:'1.2-2') || '0.00' }}</td>
                <td class="px-4 py-2.5 text-right" [class]="(item.oct || 0) > 0 ? 'text-green-600 font-medium' : 'text-gray-400'">{{ (item.oct | number:'1.2-2') || '-' }}</td>
                <td class="px-4 py-2.5 text-right" [class]="(item.nov || 0) > 0 ? 'text-green-600 font-medium' : 'text-gray-400'">{{ (item.nov | number:'1.2-2') || '-' }}</td>
                <td class="px-4 py-2.5 text-right" [class]="(item.dece || 0) > 0 ? 'text-green-600 font-medium' : 'text-gray-400'">{{ (item.dece | number:'1.2-2') || '-' }}</td>
                <td class="px-4 py-2.5 text-right" [class]="(item.jan || 0) > 0 ? 'text-green-600 font-medium' : 'text-gray-400'">{{ (item.jan | number:'1.2-2') || '-' }}</td>
                <td class="px-4 py-2.5 text-right" [class]="(item.feb || 0) > 0 ? 'text-green-600 font-medium' : 'text-gray-400'">{{ (item.feb | number:'1.2-2') || '-' }}</td>
                <td class="px-4 py-2.5 text-right" [class]="(item.mar || 0) > 0 ? 'text-green-600 font-medium' : 'text-gray-400'">{{ (item.mar | number:'1.2-2') || '-' }}</td>
                <td class="px-4 py-2.5 text-right" [class]="(item.apr || 0) > 0 ? 'text-green-600 font-medium' : 'text-gray-400'">{{ (item.apr | number:'1.2-2') || '-' }}</td>
                <td class="px-4 py-2.5 text-right" [class]="(item.may_val || 0) > 0 ? 'text-green-600 font-medium' : 'text-gray-400'">{{ (item.may_val | number:'1.2-2') || '-' }}</td>
                <td class="px-4 py-2.5 text-right" [class]="(item.jun || 0) > 0 ? 'text-green-600 font-medium' : 'text-gray-400'">{{ (item.jun | number:'1.2-2') || '-' }}</td>
                <td class="px-4 py-2.5 text-right" [class]="(item.jul || 0) > 0 ? 'text-green-600 font-medium' : 'text-gray-400'">{{ (item.jul | number:'1.2-2') || '-' }}</td>
                <td class="px-4 py-2.5 text-right" [class]="(item.aug || 0) > 0 ? 'text-green-600 font-medium' : 'text-gray-400'">{{ (item.aug | number:'1.2-2') || '-' }}</td>
                <td class="px-4 py-2.5 text-right" [class]="(item.sep || 0) > 0 ? 'text-green-600 font-medium' : 'text-gray-400'">{{ (item.sep | number:'1.2-2') || '-' }}</td>
                <td class="px-4 py-2.5 text-right font-bold text-green-700">{{ (item.total_actual | number:'1.2-2') || '0.00' }}</td>
                <td class="px-4 py-2.5 text-right font-bold" [class]="(item.target_value > 0 && item.total_actual >= item.target_value) ? 'text-green-600' : 'text-red-500'">
                  {{ item.target_value > 0 ? ((item.total_actual / item.target_value * 100) | number:'1.2-2') + '%' : '-' }}
                </td>
                <td class="px-4 py-2.5 text-center text-gray-600">{{ item.hospital_count }}</td>
              </tr>
              <tr *ngIf="reportData.length === 0">
                <td colspan="20" class="px-4 py-8 text-center text-gray-400"><i class="fas fa-inbox text-3xl mb-2"></i><br>ไม่พบข้อมูล</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Tab: by-hospital -->
        <div *ngIf="activeTab === 'by-hospital'" class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-blue-50 text-blue-800">
              <tr>
                <th class="px-4 py-3 text-left font-bold">#</th>
                <th class="px-4 py-3 text-left font-bold">รหัส รพ.</th>
                <th class="px-4 py-3 text-left font-bold">ชื่อหน่วยบริการ</th>
                <th class="px-4 py-3 text-left font-bold">อำเภอ</th>
                <th class="px-4 py-3 text-right font-bold">จำนวนตัวชี้วัด</th>
                <th class="px-4 py-3 text-right font-bold">เป้าหมายรวม</th>
                <th class="px-4 py-3 text-right font-bold">ผลงานรวม</th>
                <th class="px-4 py-3 text-right font-bold">%สำเร็จ</th>
                <th class="px-4 py-3 text-right font-bold">อนุมัติ</th>
                <th class="px-4 py-3 text-right font-bold">รออนุมัติ</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of reportData; let i = index" class="border-b border-gray-50 hover:bg-blue-50/30 transition-colors">
                <td class="px-4 py-2.5 text-gray-500">{{ i + 1 }}</td>
                <td class="px-4 py-2.5 text-gray-600 font-mono text-xs">{{ item.hospcode }}</td>
                <td class="px-4 py-2.5 text-gray-800 font-medium">{{ item.hosname }}</td>
                <td class="px-4 py-2.5 text-gray-600">{{ item.distname }}</td>
                <td class="px-4 py-2.5 text-right text-gray-700">{{ item.indicator_count }}</td>
                <td class="px-4 py-2.5 text-right text-gray-700">{{ (item.total_target | number:'1.2-2') || '0.00' }}</td>
                <td class="px-4 py-2.5 text-right font-bold text-green-700">{{ (item.total_actual | number:'1.2-2') || '0.00' }}</td>
                <td class="px-4 py-2.5 text-right font-bold" [class]="(item.achievement_pct >= 100) ? 'text-green-600' : 'text-red-500'">
                  {{ (item.achievement_pct | number:'1.2-2') || '0.00' }}%
                </td>
                <td class="px-4 py-2.5 text-right text-green-600">{{ item.approved_count }}</td>
                <td class="px-4 py-2.5 text-right text-orange-500">{{ item.pending_count }}</td>
              </tr>
              <tr *ngIf="reportData.length === 0">
                <td colspan="10" class="px-4 py-8 text-center text-gray-400"><i class="fas fa-inbox text-3xl mb-2"></i><br>ไม่พบข้อมูล</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Tab: by-district -->
        <div *ngIf="activeTab === 'by-district'" class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-indigo-50 text-indigo-800">
              <tr>
                <th class="px-4 py-3 text-left font-bold">#</th>
                <th class="px-4 py-3 text-left font-bold">อำเภอ</th>
                <th class="px-4 py-3 text-right font-bold">จำนวน รพ.</th>
                <th class="px-4 py-3 text-right font-bold">จำนวนตัวชี้วัด</th>
                <th class="px-4 py-3 text-right font-bold">เป้าหมายรวม</th>
                <th class="px-4 py-3 text-right font-bold">ผลงานรวม</th>
                <th class="px-4 py-3 text-right font-bold">%สำเร็จ</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of reportData; let i = index" class="border-b border-gray-50 hover:bg-indigo-50/30 transition-colors">
                <td class="px-4 py-2.5 text-gray-500">{{ i + 1 }}</td>
                <td class="px-4 py-2.5 text-gray-800 font-medium">{{ item.distname || item.distid }}</td>
                <td class="px-4 py-2.5 text-right text-gray-700">{{ item.hospital_count }}</td>
                <td class="px-4 py-2.5 text-right text-gray-700">{{ item.indicator_count }}</td>
                <td class="px-4 py-2.5 text-right text-gray-700">{{ (item.total_target | number:'1.2-2') || '0.00' }}</td>
                <td class="px-4 py-2.5 text-right font-bold text-green-700">{{ (item.total_actual | number:'1.2-2') || '0.00' }}</td>
                <td class="px-4 py-2.5 text-right font-bold" [class]="(item.achievement_pct >= 100) ? 'text-green-600' : 'text-red-500'">
                  {{ (item.achievement_pct | number:'1.2-2') || '0.00' }}%
                </td>
              </tr>
              <tr *ngIf="reportData.length === 0">
                <td colspan="7" class="px-4 py-8 text-center text-gray-400"><i class="fas fa-inbox text-3xl mb-2"></i><br>ไม่พบข้อมูล</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Tab: by-year -->
        <div *ngIf="activeTab === 'by-year'" class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-amber-50 text-amber-800">
              <tr>
                <th class="px-4 py-3 text-left font-bold">#</th>
                <th class="px-4 py-3 text-left font-bold">ปีงบประมาณ</th>
                <th class="px-4 py-3 text-right font-bold">จำนวนตัวชี้วัด</th>
                <th class="px-4 py-3 text-right font-bold">จำนวน รพ.</th>
                <th class="px-4 py-3 text-right font-bold">เป้าหมายรวม</th>
                <th class="px-4 py-3 text-right font-bold">ผลงานรวม</th>
                <th class="px-4 py-3 text-right font-bold">%สำเร็จ</th>
                <th class="px-4 py-3 text-right font-bold">อนุมัติ</th>
                <th class="px-4 py-3 text-right font-bold">รออนุมัติ</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of reportData; let i = index" class="border-b border-gray-50 hover:bg-amber-50/30 transition-colors">
                <td class="px-4 py-2.5 text-gray-500">{{ i + 1 }}</td>
                <td class="px-4 py-2.5 text-gray-800 font-bold text-base">{{ item.year_bh }}</td>
                <td class="px-4 py-2.5 text-right text-gray-700">{{ item.indicator_count }}</td>
                <td class="px-4 py-2.5 text-right text-gray-700">{{ item.hospital_count }}</td>
                <td class="px-4 py-2.5 text-right text-gray-700">{{ (item.total_target | number:'1.2-2') || '0.00' }}</td>
                <td class="px-4 py-2.5 text-right font-bold text-green-700">{{ (item.total_actual | number:'1.2-2') || '0.00' }}</td>
                <td class="px-4 py-2.5 text-right font-bold" [class]="(item.achievement_pct >= 100) ? 'text-green-600' : 'text-red-500'">
                  {{ (item.achievement_pct | number:'1.2-2') || '0.00' }}%
                </td>
                <td class="px-4 py-2.5 text-right text-green-600">{{ item.approved_count }}</td>
                <td class="px-4 py-2.5 text-right text-orange-500">{{ item.pending_count }}</td>
              </tr>
              <tr *ngIf="reportData.length === 0">
                <td colspan="9" class="px-4 py-8 text-center text-gray-400"><i class="fas fa-inbox text-3xl mb-2"></i><br>ไม่พบข้อมูล</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Charts -->
      <div *ngIf="!isLoading && reportData.length > 0" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
        <apx-chart
          [series]="barChartOptions.series"
          [chart]="barChartOptions.chart"
          [plotOptions]="barChartOptions.plotOptions"
          [dataLabels]="barChartOptions.dataLabels"
          [stroke]="barChartOptions.stroke"
          [xaxis]="barChartOptions.xaxis"
          [yaxis]="barChartOptions.yaxis"
          [colors]="barChartOptions.colors"
          [title]="barChartOptions.title"
          [tooltip]="barChartOptions.tooltip"
          [labels]="barChartOptions.labels"
        ></apx-chart>
      </div>

      <div *ngIf="!isLoading && activeTab === 'by-district' && reportData.length > 0" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
        <apx-chart
          [series]="pieChartOptions.series"
          [chart]="pieChartOptions.chart"
          [labels]="pieChartOptions.labels"
          [title]="pieChartOptions.title"
          [tooltip]="pieChartOptions.tooltip"
          [dataLabels]="pieChartOptions.dataLabels"
          [responsive]="pieChartOptions.responsive"
        ></apx-chart>
      </div>

    </main>
  </div>

  <!-- Modal เปลี่ยนรหัสผ่าน -->
  <div *ngIf="showChangePasswordModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-4 sm:p-6 transform transition-all scale-100">
      <div class="flex items-center mb-4 sm:mb-5">
        <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center mr-3">
          <i class="fas fa-key text-green-600"></i>
        </div>
        <h3 class="text-lg sm:text-xl font-bold text-gray-800">เปลี่ยนรหัสผ่าน</h3>
      </div>
      <div class="space-y-3 sm:space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">รหัสผ่านปัจจุบัน</label>
          <div class="relative">
            <input [type]="showCurrentPw ? 'text' : 'password'" [(ngModel)]="changePasswordForm.currentPassword" placeholder="กรอกรหัสผ่านปัจจุบัน"
              class="w-full px-3 sm:px-4 py-2.5 sm:py-3 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none hover:border-green-400 transition-colors">
            <button type="button" (click)="showCurrentPw = !showCurrentPw" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 focus:outline-none">
              <i [class]="showCurrentPw ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
            </button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">รหัสผ่านใหม่</label>
          <div class="relative">
            <input [type]="showNewPw ? 'text' : 'password'" [(ngModel)]="changePasswordForm.newPassword" placeholder="อย่างน้อย 6 ตัวอักษร"
              class="w-full px-3 sm:px-4 py-2.5 sm:py-3 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none hover:border-green-400 transition-colors">
            <button type="button" (click)="showNewPw = !showNewPw" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 focus:outline-none">
              <i [class]="showNewPw ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
            </button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ยืนยันรหัสผ่านใหม่</label>
          <div class="relative">
            <input [type]="showConfirmPw ? 'text' : 'password'" [(ngModel)]="changePasswordForm.confirmPassword" placeholder="กรอกรหัสผ่านใหม่อีกครั้ง"
              class="w-full px-3 sm:px-4 py-2.5 sm:py-3 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none hover:border-green-400 transition-colors"
              [ngClass]="changePasswordForm.confirmPassword && changePasswordForm.newPassword !== changePasswordForm.confirmPassword ? 'border-red-400 focus:ring-red-400' : ''">
            <button type="button" (click)="showConfirmPw = !showConfirmPw" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 focus:outline-none">
              <i [class]="showConfirmPw ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
            </button>
          </div>
          <p *ngIf="changePasswordForm.confirmPassword && changePasswordForm.newPassword !== changePasswordForm.confirmPassword" class="text-xs text-red-500 mt-1">รหัสผ่านไม่ตรงกัน</p>
        </div>
      </div>
      <div class="mt-4 sm:mt-6 flex flex-col sm:flex-row justify-end gap-2 sm:gap-3">
        <button (click)="closeChangePasswordModal()" class="w-full sm:w-auto px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-bold transition-colors">ยกเลิก</button>
        <button (click)="saveNewPassword()" class="w-full sm:w-auto px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold shadow-md transition-colors">
          <i class="fas fa-save mr-2"></i>บันทึก
        </button>
      </div>
    </div>
  </div>
</div>
