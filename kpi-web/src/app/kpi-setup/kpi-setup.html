<div class="flex h-screen bg-gray-100 font-sans overflow-hidden">
  <!-- Sidebar -->
  <aside class="bg-gradient-to-b from-green-800 to-green-600 text-white flex flex-col shadow-xl z-20 transition-all duration-700 ease-in-out overflow-hidden whitespace-nowrap" [ngClass]="isSidebarOpen ? 'w-64 opacity-100' : 'w-0 opacity-0'">
    <div class="h-16 flex items-center px-6 border-b border-green-500/30 bg-green-900/20">
      <i class="fas fa-heartbeat text-2xl mr-3"></i>
      <span class="text-lg font-bold tracking-wide">Korat Health KPI</span>
    </div>

    <nav class="flex-1 px-4 py-6 space-y-2 overflow-y-auto">
      <a routerLink="/charts" class="flex items-center px-4 py-3 text-green-100 hover:bg-white/10 hover:text-white rounded-xl transition-colors cursor-pointer">
        <i class="fas fa-chart-bar text-xl mr-3"></i> รายงานสถิติ
      </a>
      <a routerLink="/reports" class="flex items-center px-4 py-3 text-green-100 hover:bg-white/10 hover:text-white rounded-xl transition-colors cursor-pointer">
        <i class="fas fa-file-alt text-xl mr-3 min-w-[24px]"></i>
        <span class="truncate">รายงานสรุปผล</span>
      </a>
      <a routerLink="/notifications" class="flex items-center px-4 py-2.5 text-green-100 hover:bg-white/10 hover:text-white rounded-xl transition-colors cursor-pointer">
        <i class="fas fa-bell text-lg mr-3 min-w-[24px]"></i>
        <span class="truncate flex justify-between items-center w-full">
          แจ้งเตือน
          <span *ngIf="unreadNotifCount > 0" class="flex h-5 min-w-[20px] px-1 items-center justify-center rounded-full bg-red-500 text-[10px] font-bold text-white animate-pulse">{{ unreadNotifCount }}</span>
        </span>
      </a>
      <a routerLink="/dashboard" class="flex items-center px-4 py-3 text-green-100 hover:bg-white/10 hover:text-white rounded-xl transition-colors cursor-pointer">
        <i class="fas fa-th-large text-xl mr-3"></i>
        <span class="truncate flex justify-between items-center w-full">
          ภาพรวมตัวชี้วัด
          <span *ngIf="(isAdmin || isSuperAdmin) && pendingKpiCount > 0" class="flex h-5 w-5 items-center justify-center rounded-full bg-red-500 text-[10px] font-bold text-white ml-2 animate-pulse shadow-lg">
            {{ pendingKpiCount }}
          </span>
        </span>
      </a>
      <a *ngIf="isAdmin || isSuperAdmin" routerLink="/users" class="flex items-center px-4 py-2.5 text-green-100 hover:bg-white/10 hover:text-white rounded-xl transition-colors cursor-pointer text-sm">
        <i class="fas fa-users-cog text-lg mr-3 min-w-[24px]"></i>
        <span class="truncate flex justify-between items-center w-full">
          จัดการผู้ใช้งาน
          
        </span>
      </a>
      <a *ngIf="isAdmin || isSuperAdmin" routerLink="/kpi-manage" class="flex items-center px-4 py-2.5 text-green-100 hover:bg-white/10 hover:text-white rounded-xl transition-colors cursor-pointer text-sm">
        <i class="fas fa-tasks text-lg mr-3 min-w-[24px]"></i>
        <span class="truncate flex justify-between items-center w-full">
          จัดการตัวชี้วัด
          
        </span>
      </a>
      <a *ngIf="isAdmin || isSuperAdmin" routerLink="/audit-logs" class="flex items-center px-4 py-2.5 text-green-100 hover:bg-white/10 hover:text-white rounded-xl transition-colors cursor-pointer text-sm">
        <i class="fas fa-history text-lg mr-3 min-w-[24px]"></i>
        <span class="truncate flex justify-between items-center w-full">
          ประวัติการใช้งาน
          
        </span>
      </a>
      <a *ngIf="isAdmin || isSuperAdmin" routerLink="/kpi-setup" class="flex items-center px-4 py-2.5 text-green-100 hover:bg-white/10 hover:text-white rounded-xl transition-colors cursor-pointer text-sm">
        <i class="fas fa-plus-circle text-lg mr-3 min-w-[24px]"></i>
        <span class="truncate flex justify-between items-center w-full">
          +KPI ปีงบประมาณใหม่
          
        </span>
      </a>
      <!-- เพิ่มปุ่มตั้งค่าระบบ (Admin/Super Admin) -->
      <a *ngIf="isAdmin || isSuperAdmin" routerLink="/settings" class="flex items-center px-4 py-2.5 text-green-100 hover:bg-white/10 hover:text-white rounded-xl transition-colors cursor-pointer text-sm">
        <i class="fas fa-sliders-h text-lg mr-3 min-w-[24px]"></i>
        <span class="truncate flex justify-between items-center w-full">
          ตั้งค่าระบบ
          
        </span>
      </a>
    </nav>

    <div class="p-4 border-t border-green-500/30">
      <button (click)="openChangePasswordModal()" class="flex items-center w-full px-4 py-3 text-green-100 hover:bg-white/10 hover:text-white rounded-xl transition-colors cursor-pointer mb-1">
        <i class="fas fa-key text-xl mr-3 min-w-[24px]"></i>
        <span class="truncate">เปลี่ยนรหัสผ่าน</span>
      </button>
      <button (click)="logout()" class="flex items-center w-full px-4 py-3 text-green-100 hover:bg-red-500 hover:text-white rounded-xl transition-colors cursor-pointer">
        <i class="fas fa-sign-out-alt text-xl mr-3"></i> ออกจากระบบ
      </button>
      <div class="mt-4 text-center text-xs text-green-200/60 font-mono">
        {{ systemVersion }}
      </div>
    </div>
  </aside>

  <div class="flex-1 flex flex-col overflow-hidden">
    <header class="h-16 bg-gradient-to-r from-green-800 to-green-600 shadow-md flex items-center justify-between px-6 z-10">
      <div class="flex items-center">
        <button (click)="toggleSidebar()" class="text-white hover:text-green-200 focus:outline-none mr-4 lg:hidden" [ngClass]="isSidebarOpen ? 'block' : 'block'">
          <i class="fas fa-bars text-xl"></i>
        </button>
        <button (click)="toggleSidebar()" class="text-white hover:text-green-200 focus:outline-none mr-4 hidden lg:block" [ngClass]="isSidebarOpen ? 'hidden' : 'block'">
          <i class="fas fa-bars text-xl"></i>
        </button>
        <h2 class="text-xl font-semibold text-white">ตั้งค่า KPI ปีงบประมาณใหม่</h2>
        <span *ngIf="(isAdmin || isSuperAdmin) && pendingKpiCount > 0" class="flex h-6 min-w-[24px] px-1.5 items-center justify-center rounded-full bg-red-500 text-[11px] font-bold text-white ml-2 animate-pulse shadow-lg">
          {{ pendingKpiCount }}
        </span>
      </div>
      <div class="flex items-center">
        <!-- Bell Icon + Notification Dropdown -->
        <div class="relative mr-4">
          <button (click)="toggleNotifDropdown()" class="relative text-white hover:text-green-200 focus:outline-none">
            <i class="fas fa-bell text-xl"></i>
            <span *ngIf="unreadNotifCount > 0" class="absolute -top-1 -right-1 flex h-4 min-w-[16px] px-0.5 items-center justify-center rounded-full bg-red-500 text-[9px] font-bold text-white animate-pulse">
              {{ unreadNotifCount > 99 ? '99+' : unreadNotifCount }}
            </span>
          </button>
          <div *ngIf="showNotifDropdown" class="absolute right-0 top-10 w-80 bg-white rounded-xl shadow-2xl border border-gray-200 z-50 max-h-96 overflow-hidden">
            <div class="flex items-center justify-between px-4 py-3 border-b bg-gray-50 rounded-t-xl">
              <span class="font-bold text-gray-700 text-sm">การแจ้งเตือน</span>
              <button *ngIf="unreadNotifCount > 0" (click)="markAllNotifsRead()" class="text-xs text-green-600 hover:text-green-800 font-medium">อ่านทั้งหมด</button>
            </div>
            <div class="overflow-y-auto max-h-72">
              <div *ngIf="notifications.length === 0" class="p-6 text-center text-gray-400 text-sm">ไม่มีการแจ้งเตือน</div>
              <div *ngFor="let notif of notifications.slice(0, 10)"
                   (click)="!notif.is_read && markNotifAsRead([notif.id])"
                   class="px-4 py-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-colors"
                   [ngClass]="notif.is_read ? 'bg-white' : 'bg-blue-50/50'">
                <div class="flex items-start gap-2">
                  <i class="fas mt-0.5 text-sm" [ngClass]="notif.type === 'approve' ? 'fa-check-circle text-green-500' : notif.type === 'reject' ? 'fa-times-circle text-red-500' : 'fa-info-circle text-blue-500'"></i>
                  <div class="flex-1 min-w-0">
                    <p class="text-xs font-semibold text-gray-800 truncate">{{ notif.title }}</p>
                    <p class="text-[11px] text-gray-500 line-clamp-2">{{ notif.message }}</p>
                    <p class="text-[10px] text-gray-400 mt-1">{{ notif.created_at | date:'dd/MM/yyyy HH:mm' }}</p>
                  </div>
                  <span *ngIf="!notif.is_read" class="h-2 w-2 rounded-full bg-blue-500 mt-1 shrink-0"></span>
                </div>
              </div>
            </div>
            <a routerLink="/notifications" (click)="showNotifDropdown = false" class="block text-center py-2.5 text-xs text-green-600 hover:text-green-800 font-medium border-t bg-gray-50 rounded-b-xl hover:bg-gray-100 transition-colors">
              ดูทั้งหมด →
            </a>
          </div>
        </div>
        <div class="text-right mr-3 hidden sm:block">
          <p class="text-sm font-bold text-white">({{ currentUserDisplay?.role }}) {{ currentUserDisplay?.firstname }} {{ currentUserDisplay?.lastname }}</p>
          <p class="text-xs text-green-100">{{ currentUserDisplay?.service_unit || currentUserDisplay?.role }}</p>
        </div>
        <div class="h-10 w-10 rounded-full bg-white/20 border-2 border-white/30 flex items-center justify-center text-white font-bold backdrop-blur-sm">
          {{ currentUserDisplay?.username?.charAt(0).toUpperCase() }}
        </div>
      </div>
    </header>

    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 p-6">
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-6">
        <div class="p-6 border-b border-gray-100 grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">ปีงบประมาณ</label>
                <select [(ngModel)]="selectedYear" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none text-sm hover:border-green-400 transition-colors">
                    <option value="2569">2569</option>
                    <option value="2570">2570</option>
                    <option value="2571">2571</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">อำเภอ</label>
                <select [(ngModel)]="selectedDistrict" (change)="onDistrictChange()" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none text-sm hover:border-green-400 transition-colors">
                    <option value="">ทั้งหมด</option>
                    <option *ngFor="let d of districts" [value]="d.distid">{{ d.distname }}</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">หน่วยบริการ</label>
                <select [(ngModel)]="selectedHospital" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 outline-none text-sm hover:border-green-400 transition-colors">
                    <option value="">-- เลือกหน่วยบริการ --</option>
                    <option *ngFor="let h of filteredHospitals" [value]="h.hoscode">{{ h.hoscode }}: {{ h.hosname }}</option>
                </select>
            </div>
            <div class="flex items-end">
                <button (click)="saveSetup()" class="w-full py-2.5 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl text-sm transition-colors shadow-lg">
                    <i class="fas fa-save mr-2"></i> บันทึกข้อมูล
                </button>
            </div>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="overflow-x-auto h-[calc(100vh-300px)]">
            <table class="w-full text-left border-collapse min-w-[1600px]">
              <thead class="sticky top-0 z-50 shadow-sm">
                <tr class="bg-gradient-to-r from-green-700 to-green-600 text-white text-sm uppercase font-bold">
                  <th class="px-4 py-4 w-48 sticky left-0 bg-green-700 z-50 rounded-tl-xl">หมวดหมู่หลัก</th>
                  <th class="px-4 py-4 w-64 sticky left-48 bg-green-700 border-r border-green-600 z-50">ชื่อตัวชี้วัด</th>
                  <th class="px-4 py-4 w-24 bg-green-700 border-r border-green-600 text-center">ปีงบฯ</th>
                  <th class="px-4 py-4 w-64 border-r border-green-600">หน่วยงาน</th>
                  <th class="px-3 py-4 text-right bg-green-800">เป้าหมาย</th>
                  <th class="px-3 py-4 text-right bg-green-800">ผลงานรวม</th>
                  <th class="px-2 py-4 text-center border-x border-green-600 last:rounded-tr-xl" *ngFor="let m of ['ต.ค.','พ.ย.','ธ.ค.','ม.ค.','ก.พ.','มี.ค.','เม.ย.','พ.ค.','มิ.ย.','ก.ค.','ส.ค.','ก.ย.']">
                    {{m}}
                  </th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100 bg-white">
                <tr *ngFor="let item of kpiTemplate" class="hover:bg-gray-50 transition-colors text-xs">
                  <td class="px-4 py-3 font-bold text-green-800 bg-green-50 border-r border-gray-100 align-top sticky left-0 z-20">{{ item.main_indicator_name }}</td>
                  <td class="px-4 py-3 border-r font-medium text-gray-900 sticky left-48 bg-white z-20">{{ item.kpi_indicators_name }}</td>
                  <td class="px-4 py-3 text-center font-medium text-gray-600 border-r">{{ item.year_bh }}</td>
                  <td class="px-4 py-3 border-r font-medium text-gray-900">{{ item.dept_name }}</td>
                  <td class="px-3 py-3 text-right bg-yellow-50/30 font-bold">
                    <input type="number" min="0" [(ngModel)]="item.target_value" class="w-full border border-gray-300 rounded px-1 py-1 text-right text-xs focus:outline-none focus:border-green-500 bg-white hover:border-green-400 transition-colors">
                  </td>
                  <td class="px-3 py-3 text-right bg-blue-50/30 font-bold text-blue-600">{{ item.total_actual | number }}</td>
                  <td class="px-2 py-3 text-center border-x" *ngFor="let m of ['oct','nov','dece','jan','feb','mar','apr','may','jun','jul','aug','sep']">
                    <input type="number" min="0" [(ngModel)]="item[m]" (ngModelChange)="onValueChange(item, m)" class="w-full border border-gray-300 rounded px-1 py-1 text-center text-xs focus:outline-none focus:border-green-500 bg-white hover:border-green-400 transition-colors">
                  </td>
                </tr>
              </tbody>
            </table>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal เปลี่ยนรหัสผ่าน -->
  <div *ngIf="showChangePasswordModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-4 sm:p-6 transform transition-all scale-100">
      <div class="flex items-center mb-4 sm:mb-5">
        <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center mr-3">
          <i class="fas fa-key text-green-600"></i>
        </div>
        <h3 class="text-lg sm:text-xl font-bold text-gray-800">เปลี่ยนรหัสผ่าน</h3>
      </div>
      <div class="space-y-3 sm:space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">รหัสผ่านปัจจุบัน</label>
          <div class="relative">
            <input [type]="showCurrentPw ? 'text' : 'password'" [(ngModel)]="changePasswordForm.currentPassword" placeholder="กรอกรหัสผ่านปัจจุบัน"
              class="w-full px-3 sm:px-4 py-2.5 sm:py-3 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none hover:border-green-400 transition-colors">
            <button type="button" (click)="showCurrentPw = !showCurrentPw" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 focus:outline-none">
              <i [class]="showCurrentPw ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
            </button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">รหัสผ่านใหม่</label>
          <div class="relative">
            <input [type]="showNewPw ? 'text' : 'password'" [(ngModel)]="changePasswordForm.newPassword" placeholder="อย่างน้อย 6 ตัวอักษร"
              class="w-full px-3 sm:px-4 py-2.5 sm:py-3 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none hover:border-green-400 transition-colors">
            <button type="button" (click)="showNewPw = !showNewPw" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 focus:outline-none">
              <i [class]="showNewPw ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
            </button>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ยืนยันรหัสผ่านใหม่</label>
          <div class="relative">
            <input [type]="showConfirmPw ? 'text' : 'password'" [(ngModel)]="changePasswordForm.confirmPassword" placeholder="กรอกรหัสผ่านใหม่อีกครั้ง"
              class="w-full px-3 sm:px-4 py-2.5 sm:py-3 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 outline-none hover:border-green-400 transition-colors"
              [ngClass]="changePasswordForm.confirmPassword && changePasswordForm.newPassword !== changePasswordForm.confirmPassword ? 'border-red-400 focus:ring-red-400' : ''">
            <button type="button" (click)="showConfirmPw = !showConfirmPw" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 focus:outline-none">
              <i [class]="showConfirmPw ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
            </button>
          </div>
          <p *ngIf="changePasswordForm.confirmPassword && changePasswordForm.newPassword !== changePasswordForm.confirmPassword" class="text-xs text-red-500 mt-1">รหัสผ่านไม่ตรงกัน</p>
        </div>
      </div>
      <div class="mt-4 sm:mt-6 flex flex-col sm:flex-row justify-end gap-2 sm:gap-3">
        <button (click)="closeChangePasswordModal()" class="w-full sm:w-auto px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-bold transition-colors">ยกเลิก</button>
        <button (click)="saveNewPassword()" class="w-full sm:w-auto px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold shadow-md transition-colors">
          <i class="fas fa-save mr-2"></i>บันทึก
        </button>
      </div>
    </div>
  </div>

  <!-- Overlay ปิด Notification Dropdown -->
  <div *ngIf="showNotifDropdown" class="fixed inset-0 z-40" (click)="showNotifDropdown = false"></div>
</div>
